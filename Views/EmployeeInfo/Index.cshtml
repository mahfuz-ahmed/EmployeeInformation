@{
    ViewData["Title"] = "Employee List";
}

<div id="deleteSuccessAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
    <i class="bi bi-check-circle me-2"></i> <span id="successMessage">Employee deleted successfully.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row mb-3">
    <div class="col-md-12 text-start d-flex justify-content-between align-items-center">
        <div>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-person-plus me-1"></i> Add New
            </a>
            <button id="btnBulkDelete" class="btn btn-danger ms-2" style="display:none;" onclick="openBulkDeleteModal()">
                <i class="bi bi-trash me-1"></i> Delete Selected
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <table id="employeeTable" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th class="no-export text-center" style="width: 30px;">
                        <input type="checkbox" id="selectAll" class="form-check-input" />
                    </th>
                    <th>Title</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Designation</th>
                    <th>Basic Salary</th>
                    <th>Net Salary</th>
                    <th>Joining Date</th>
                    <th class="no-export">Actions</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<div class="modal fade" id="commonDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="commonDeleteForm">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p id="deleteModalMessage">Are you sure you want to delete this employee?</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {

    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet" />

    <!-- DataTables + Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script>
        let deleteEmployeeId = 0;

        $(document).ready(function () {

            const table = $("#employeeTable").DataTable({
                processing: false,
                serverSide: true,
                searching: true,
                language: {
                    search: '<i class="bi bi-filter me-1"></i> Search:'
                },

                dom:
                    "<'row mb-2 align-items-center'\
                        <'col-auto'l>\
                        <'col-auto ms-3'f>\
                        <'col text-end'B>\
                     >\
                     rtip",

                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Excel',
                        className: 'btn btn-success btn-sm me-1',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        className: 'btn btn-danger btn-sm',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    }
                ],

                ajax: {
                    url: "/EmployeeInfo/GetEmployees",
                    type: "GET",
                    data: function (d) {
                        d.page = (d.start / d.length) + 1;
                        d.pageSize = d.length;
                        d.searchTerm = d.search.value;
                        if (d.order && d.order.length > 0) {
                            d.sortColumn = d.columns[d.order[0].column].data;
                            d.sortDir = d.order[0].dir;
                        }
                    },
                    dataSrc: function (json) {
                        window.maxSalary = json.maxSalary;
                        window.minSalary = json.minSalary;
                        json.recordsTotal = json.totalCount;
                        json.recordsFiltered = json.totalCount;
                        return json.data;
                    },
                    error: function (xhr, error, code) {
                        console.error("DataTable Error:", xhr.responseText);
                        let msg = "Error loading data. ";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            msg += xhr.responseJSON.message;
                        }
                        alert(msg);
                    }
                },
                createdRow: function (row, data) {
                    if (window.maxSalary > 0 && data.basicSalary === window.maxSalary) {
                        $(row).addClass('table-success');
                    }
                    if (window.minSalary > 0 && data.basicSalary === window.minSalary) {
                        $(row).addClass('table-danger');
                    }
                },
                columns: [
                    {
                        data: "employeeId",
                        orderable: false,
                        className: "no-export text-center",
                        render: id => `<input type="checkbox" class="form-check-input row-checkbox" value="${id}" onclick="updateBulkDeleteButton()" />`
                    },
                    { data: "title", width: "60px" },
                    {
                        data: "firstName", // Sort by firstName when sorting by name column
                        render: (data, type, row) => row.firstName + " " + row.lastName
                    },
                    { data: "email" },
                    { data: "phoneNumber" },
                    { data: "designationName" },
                    {
                        data: "basicSalary",
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: "netSalary",
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: "joiningDate",
                        render: d => d ? new Date(d).toLocaleDateString() : ""
                    },
                    {
                        data: "employeeId",
                        orderable: false,
                        className: "no-export text-end",
                        render: id => `
                            <a href="/EmployeeInfo/Edit/${id}" class="btn btn-sm btn-warning me-1">Edit</a>
                            <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${id})">
                                Delete
                            </button>
                        `
                    }
                ],
                order: [[2, 'asc']] // Default order by Name column (now 3rd col, index 2)
            });

            // Select All functionality
            $("#selectAll").on("click", function () {
                $(".row-checkbox").prop("checked", this.checked);
                updateBulkDeleteButton();
            });

            $("#commonDeleteForm").on("submit", function (e) {
                e.preventDefault();

                if (deleteEmployeeId > 0) {
                    // Single delete
                    $.ajax({
                        url: '/EmployeeInfo/Delete/' + deleteEmployeeId,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken':
                                $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (res) {
                            if (res.success) {
                                $('#commonDeleteModal').modal('hide');
                                table.ajax.reload(null, false);
                                showSuccess("Employee deleted successfully.");
                            }
                        }
                    });
                } else {
                    // Bulk delete
                    const ids = getSelectedIds();
                    $.ajax({
                        url: '/EmployeeInfo/DeleteMultiple',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(ids),
                        headers: {
                            'RequestVerificationToken':
                                $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (res) {
                            if (res.success) {
                                $('#commonDeleteModal').modal('hide');
                                table.ajax.reload(null, false);
                                $("#selectAll").prop("checked", false);
                                updateBulkDeleteButton();
                                showSuccess("Selected employees deleted successfully.");
                            }
                        }
                    });
                }
            });
        });

        function showSuccess(msg) {
            $("#successMessage").text(msg);
            $("#deleteSuccessAlert").fadeIn();
            setTimeout(function () {
                $("#deleteSuccessAlert").fadeOut();
            }, 3000);
        }

        function getSelectedIds() {
            const ids = [];
            $(".row-checkbox:checked").each(function () {
                ids.push(parseInt($(this).val()));
            });
            return ids;
        }

        function updateBulkDeleteButton() {
            const selectedCount = $(".row-checkbox:checked").length;
            if (selectedCount > 0) {
                $("#btnBulkDelete").fadeIn();
            } else {
                $("#btnBulkDelete").fadeOut();
            }
        }

        function openDeleteModal(id) {
            deleteEmployeeId = id;
            $("#deleteModalMessage").text("Are you sure you want to delete this employee?");
            $('#commonDeleteModal').modal('show');
        }

        function openBulkDeleteModal() {
            deleteEmployeeId = 0;
            const count = $(".row-checkbox:checked").length;
            $("#deleteModalMessage").text(`Are you sure you want to delete ${count} selected employees?`);
            $('#commonDeleteModal').modal('show');
        }
    </script>

    <style>
        .dataTables_filter input {
            width: 180px;
        }
    </style>
}
