@{
    ViewData["Title"] = "Employee List";
}

@* <div class="row mb-3">
    <div class="col-md-12 text-start">
        <a asp-action="Create" class="btn btn-primary">
            Add New Employee
        </a>
    </div>
</div> *@

<div id="deleteSuccessAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
    <i class="bi bi-check-circle me-2"></i> Employee deleted successfully.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row mb-3">
    <div class="col-md-12 text-start">
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Add New
        </a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <table id="employeeTable" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Designation</th>
                    <th>Basic Salary</th>
                    <th>Net Salary</th>
                    <th>Joining Date</th>
                    <th class="no-export">Actions</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<div class="modal fade" id="commonDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="commonDeleteForm">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    Are you sure you want to delete this employee?
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {

    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet" />

    <!-- DataTables + Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script>
        let deleteEmployeeId = 0;

        $(document).ready(function () {

            const table = $("#employeeTable").DataTable({
                processing: false,
                serverSide: true,
                searching: true,
                language: {
                    search: '<i class="bi bi-filter me-1"></i> Search:'
                },

                dom:
                    "<'row mb-2 align-items-center'\
                        <'col-auto'l>\
                        <'col-auto ms-3'f>\
                        <'col text-end'B>\
                     >\
                     rtip",

                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Excel',
                        className: 'btn btn-success btn-sm me-1',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        className: 'btn btn-danger btn-sm',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    }
                ],

                ajax: {
                    url: "/EmployeeInfo/GetEmployees",
                    type: "GET",
                    data: function (d) {
                        d.page = (d.start / d.length) + 1;
                        d.pageSize = d.length;
                        d.searchTerm = d.search.value;
                    },
                    dataSrc: function (json) {
                        window.maxSalary = json.maxSalary;
                        window.minSalary = json.minSalary;
                        json.recordsTotal = json.totalCount;
                        json.recordsFiltered = json.totalCount;
                        return json.data;
                    },
                    error: function (xhr, error, code) {
                        console.error("DataTable Error:", xhr.responseText);
                        let msg = "Error loading data. ";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            msg += xhr.responseJSON.message;
                        }
                        alert(msg);
                    }
                },

                createdRow: function (row, data) {
                    if (window.maxSalary > 0 && data.basicSalary === window.maxSalary) {
                        $(row).addClass('table-success');
                    }
                    if (window.minSalary > 0 && data.basicSalary === window.minSalary) {
                        $(row).addClass('table-danger');
                    }
                },

                columns: [
                    { data: "title", width: "60px" },
                    {
                        data: null,
                        render: row => row.firstName + " " + row.lastName
                    },
                    { data: "email" },
                    { data: "phoneNumber" },
                    { data: "designationName" },
                    {
                        data: "basicSalary",
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: "netSalary",
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: "joiningDate",
                        render: d => d ? new Date(d).toLocaleDateString() : ""
                    },
                    {
                        data: "employeeId",
                        orderable: false,
                        className: "no-export",
                        render: id => `
                            <a href="/EmployeeInfo/Edit/${id}" class="btn btn-sm btn-warning me-1">Edit</a>
                            <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${id})">
                                Delete
                            </button>
                        `
                    }
                ]
            });

            $("#commonDeleteForm").on("submit", function (e) {
                e.preventDefault();

                $.ajax({
                    url: '/EmployeeInfo/Delete/' + deleteEmployeeId,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken':
                            $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (res) {
                        if (res.success) {
                            $('#commonDeleteModal').modal('hide');
                            table.ajax.reload(null, false);
                            
                            // Show success alert
                            $("#deleteSuccessAlert").fadeIn();
                            setTimeout(function () {
                                $("#deleteSuccessAlert").fadeOut();
                            }, 3000);
                        }
                    }
                });
            });
        });

        function openDeleteModal(id) {
            deleteEmployeeId = id;
            $('#commonDeleteModal').modal('show');
        }
    </script>

    <style>
        .dataTables_filter input {
            width: 180px;
        }
    </style>
}
