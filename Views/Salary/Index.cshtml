
@model IEnumerable<EmployeeInfo.Models.Salary>

@{
    ViewData["Title"] = "Salaries";
}

<div id="deleteSuccessAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
    <i class="bi bi-check-circle me-2"></i> <span id="successMessage">Salary record deleted successfully.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div id="deleteErrorAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none;">
    <i class="bi bi-exclamation-triangle me-2"></i> <span id="errorMessage">Error deleting salary record.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row mb-3">
    <div class="col-md-12 text-start d-flex justify-content-between align-items-center">
        <div>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-wallet2 me-1"></i> Add New
            </a>
            <button id="btnBulkDelete" class="btn btn-danger ms-2" style="display:none;" onclick="openBulkDeleteModal()">
                <i class="bi bi-trash me-1"></i> Delete Selected
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <table id="salaryTable" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th class="no-export text-center" style="width: 30px;">
                        <input type="checkbox" id="selectAll" class="form-check-input" />
                    </th>
                    <th>@Html.DisplayNameFor(model => model.BasicSalary)</th>
                    <th>@Html.DisplayNameFor(model => model.Allowances)</th>
                    <th>@Html.DisplayNameFor(model => model.Deductions)</th>
                    <th>@Html.DisplayNameFor(model => model.NetSalary)</th>
                    <th class="no-export text-end" style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="commonDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="commonDeleteForm">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteModalMessage">Are you sure you want to delete this salary record?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet" />

    <!-- DataTables + Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script>
        let deleteItemId = 0;

        $(document).ready(function () {
            const table = $("#salaryTable").DataTable({
                processing: false,
                serverSide: true,
                searching: false, // Search removed as requested
                ajax: {
                    url: "/Salary/GetSalaries",
                    type: "GET",
                    data: function (d) {
                        return {
                            page: (d.start / d.length) + 1,
                            pageSize: d.length,
                            searchTerm: d.search.value,
                            sortColumn: d.columns[d.order[0].column].data,
                            sortDir: d.order[0].dir
                        };
                    },
                    dataSrc: function (json) {
                        json.recordsTotal = json.totalCount;
                        json.recordsFiltered = json.totalCount;
                        return json.data;
                    }
                },
                columns: [
                    {
                        data: "salaryId",
                        orderable: false,
                        className: "no-export text-center",
                        render: id => `<input type="checkbox" class="form-check-input row-checkbox" value="${id}" onclick="updateBulkDeleteButton()" />`
                    },
                    { data: "basicSalary", render: $.fn.dataTable.render.number(',', '.', 2) },
                    { data: "allowances", render: $.fn.dataTable.render.number(',', '.', 2) },
                    { data: "deductions", render: $.fn.dataTable.render.number(',', '.', 2) },
                    { data: "netSalary", render: $.fn.dataTable.render.number(',', '.', 2) },
                    {
                        data: "salaryId",
                        render: function (data) {
                            return `
                                <div class="text-end">
                                    <a href="/Salary/Edit/${data}" class="btn btn-sm btn-warning">Edit</a>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="openDeleteModal(${data})">
                                        Delete
                                    </button>
                                </div>
                            `;
                        },
                        orderable: false,
                        className: "no-export"
                    },
                ],
                order: [[1, 'asc']],
                dom: "<'row mb-2 align-items-center'<'col-auto'l><'col text-end'B>>rtip",
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Excel',
                        className: 'btn btn-success btn-sm me-1',
                        exportOptions: { columns: ':not(.no-export)' }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        className: 'btn btn-danger btn-sm',
                        exportOptions: { columns: ':not(.no-export)' }
                    }
                ]
            });

            $("#selectAll").on("click", function () {
                $(".row-checkbox").prop("checked", this.checked);
                updateBulkDeleteButton();
            });

            $("#commonDeleteForm").on("submit", function (e) {
                e.preventDefault();

                if (deleteItemId > 0) {
                    $.ajax({
                        url: '/Salary/Delete/' + deleteItemId,
                        type: 'POST',
                        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                        success: function (res) {
                            if (res.success) {
                                $('#commonDeleteModal').modal('hide');
                                table.ajax.reload(null, false);
                                showSuccess("Salary record deleted successfully.");
                            } else {
                                $('#commonDeleteModal').modal('hide');
                                showError(res.message);
                            }
                        }
                    });
                } else {
                    const ids = getSelectedIds();
                    $.ajax({
                        url: '/Salary/DeleteMultiple',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(ids),
                        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                        success: function (res) {
                            if (res.success) {
                                $('#commonDeleteModal').modal('hide');
                                table.ajax.reload(null, false);
                                $("#selectAll").prop("checked", false);
                                updateBulkDeleteButton();
                                if (res.message.includes("skipped")) {
                                    showError(res.message);
                                } else {
                                    showSuccess(res.message);
                                }
                            } else {
                                $('#commonDeleteModal').modal('hide');
                                showError(res.message);
                            }
                        }
                    });
                }
            });
        });

        function showSuccess(msg) {
            $("#successMessage").text(msg);
            $("#deleteSuccessAlert").fadeIn();
            setTimeout(() => $("#deleteSuccessAlert").fadeOut(), 3000);
        }

        function showError(msg) {
            $("#errorMessage").text(msg);
            $("#deleteErrorAlert").fadeIn();
            setTimeout(() => $("#deleteErrorAlert").fadeOut(), 5000);
        }

        function getSelectedIds() {
            const ids = [];
            $(".row-checkbox:checked").each(function () { ids.push(parseInt($(this).val())); });
            return ids;
        }

        function updateBulkDeleteButton() {
            const selectedCount = $(".row-checkbox:checked").length;
            if (selectedCount > 0) $("#btnBulkDelete").fadeIn();
            else $("#btnBulkDelete").fadeOut();
        }

        function openDeleteModal(id) {
            deleteItemId = id;
            $("#deleteModalMessage").text("Are you sure you want to delete this salary record?");
            $('#commonDeleteModal').modal('show');
        }

        function openBulkDeleteModal() {
            deleteItemId = 0;
            const count = $(".row-checkbox:checked").length;
            $("#deleteModalMessage").text(`Are you sure you want to delete ${count} selected salary records?`);
            $('#commonDeleteModal').modal('show');
        }
    </script>
}
